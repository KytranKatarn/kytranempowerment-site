<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Kytran Empowerment</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Lato:wght@300;700&family=League+Spartan:wght@700&family=Montserrat+Alternates:wght@600;700&family=Open+Sans&family=Oswald:wght@400;700&family=Playfair+Display+SC:ital,wght@1,400&family=Raleway:wght@500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        /* Product Detail Page Styling */
        .product-detail-section {
            padding: 60px 20px;
            background-color: #f5f5f5;
            min-height: calc(100vh - 100px - 100px);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top of the container */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .product-image-container {
            flex: 1;
            min-width: 300px; /* Minimum width for the image container */
            max-width: 500px; /* Max width for the image container */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .product-image-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto; /* Center image within its container */
            object-fit: contain;
            max-height: 450px; /* Limit image height */
        }

        .product-info-container {
            flex: 1;
            min-width: 350px; /* Minimum width for info container */
            max-width: 600px; /* Max width for info container */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .product-info-container h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 0.5em;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .product-info-container p {
            font-family: 'Open Sans', sans-serif;
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
            margin-bottom: 1em;
        }
        /* Style for hidden description */
        .product-info-container p.hidden-description {
            display: none;
        }

        .product-info-container p.price {
            font-family: 'Oswald', sans-serif;
            font-size: 2em;
            color: #e67e22;
            font-weight: 700;
            margin-bottom: 1.5em;
        }
        
        .product-options {
            margin-bottom: 1.5em;
        }

        .product-options label {
            display: block;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            margin-bottom: 8px;
            color: #34495e;
        }

        /* NEW: Variant UI styles */
        .variant-group {
            margin-bottom: 15px;
        }
        .variant-group label {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center; /* Center labels for color/size */
            width: 100%;
        }

        .color-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center; /* FIX: Center color swatches */
        }
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: border-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .color-swatch.selected {
            border-color: #3498db;
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(52,152,219,0.5);
        }
        .color-swatch:hover {
            transform: scale(1.05);
        }

        .size-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center; /* FIX: Center size buttons */
        }
        .size-button {
            padding: 8px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95em;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }
        .size-button.selected {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
            transform: translateY(-2px);
        }
        .size-button:hover:not(.disabled) {
            background-color: #e0e0e0;
        }
        .size-button.disabled {
            background-color: #eee;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #quantity-input {
            width: 80px; /* Smaller width */
            text-align: center; /* Center text */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Open Sans', sans-serif;
            font-size: 1em;
            box-sizing: border-box;
            margin-bottom: 15px;
            display: block; /* Make it a block element to center with margin auto */
            margin-left: auto;
            margin-right: auto;
        }
        /* Style the label for Quantity to also center it */
        .product-options label[for="quantity-input"] {
            text-align: center;
            width: 100%; /* Ensure label takes full width for text-align to work */
        }


        #variant-details-display {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95em;
            color: #666;
            margin-top: 10px;
            margin-bottom: 1em;
            line-height: 1.4;
            min-height: 20px;
            text-align: center; /* Center variant details */
        }
        #variant-details-display span {
            display: block;
            margin-bottom: 3px;
        }

        .product-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: auto;
            justify-content: center; /* Center buttons horizontally */
        }

        .product-actions .btn-primary {
            flex-grow: 0;
            flex-shrink: 0;
            min-width: 120px;
            max-width: 160px;
            padding: 12px 25px;
            border-radius: 5px;
            background-color: #3498db;
            color: #fff;
            text-decoration: none;
            font-family: 'Oswald', sans-serif;
            font-size: 1.1em;
            font-weight: 400;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: center;
            border: none;
            cursor: pointer;
        }

        .product-actions .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .product-actions .btn-primary.disabled {
            background-color: #cccccc; /* Gray out when disabled */
            cursor: not-allowed;
            opacity: 0.7;
            transform: none; /* No hover effect when disabled */
        }

        .merch-loading, .merch-error {
            text-align: center;
            font-family: 'Open Sans', sans-serif;
            color: #555;
            padding: 40px;
            width: 100%;
        }
        .merch-error {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .product-detail-section {
                flex-direction: column;
                align-items: center;
            }
            .product-image-container, .product-info-container {
                min-width: unset;
                width: 100%;
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <img src="logo.png" alt="Kytran Empowerment Logo" class="logo">
            <div class="header-text">
                <h1>KYTRAN EMPOWERMENT INC.</h1>
                <p class="subtitle">Strength through Strategy. Brotherhood through Purpose.</p>
            </div>

            <button class="mobile-menu-icon" aria-label="Toggle navigation">â˜°</button>

            <nav class="main-nav">
                <a href="index.html">Home</a>
                <a href="services.html">Services</a>
                <a href="membership.html">Membership</a>
                <a href="merch_store.html">Shop</a>
                <a href="books.html">Books</a>
                <a href="submit_story.html">Submit Story</a>
                <a href="https://k1.kytranempowerment.com/login">Member Login</a>
                <a href="cart.html">
                    Shopping Cart (<span id="cart-count">0</span>)
                </a>
            </nav>
        </div>

        <div class="mobile-menu-overlay" id="mobileMenu">
            <a href="index.html">Home</a>
            <a href="services.html">Services</a>
            <a href="membership.html">Membership</a>
            <a href="merch_store.html">Shop</a>
            <a href="books.html">Books</a>
            <a href="submit_story.html">Submit Story</a>
            <a href="https://k1.kytranempowerment.com/login">Member Login</a>
            <a href="cart.html">Shopping Cart (<span id="mobile-cart-count">0</span>)</a>
        </div>
    </header>

    <section class="product-detail-section">
        <p class="merch-loading" id="product-loading">Loading product details...</p>
        <p class="merch-error" id="product-error" style="display: none;"></p>

        <div class="product-image-container" id="product-image-container" style="display: none;">
            <img id="product-image" src="" alt="Product Image">
        </div>

        <div class="product-info-container" id="product-info-container" style="display: none;">
            <h2 id="product-name"></h2>
            <p id="product-description" class="hidden-description"></p> 
            <p class="price" id="product-price"></p>
            
            <div id="variant-selection-container">
                <div class="variant-group" id="color-options">
                    <label>Color:</label>
                    <div class="color-swatches"></div>
                </div>

                <div class="variant-group" id="size-options">
                    <label>Size:</label>
                    <div class="size-buttons"></div>
                </div>
                
                <input type="hidden" id="selected-variant-id">
                <input type="hidden" id="selected-variant-name">
                <input type="hidden" id="selected-variant-price">
                <input type="hidden" id="selected-variant-details-json">

                <div id="variant-details-display"></div>
            </div>

            <div class="product-options">
                <label for="quantity-input">Quantity:</label>
                <input type="number" id="quantity-input" value="1" min="1">
            </div>

            <div class="product-actions">
                <a href="merch_store.html" class="btn-primary">Back to Store</a>
                <button id="add-to-cart-btn" class="btn-primary">Add to Cart</button>
                <a href="cart.html" class="btn-primary">View Cart</a>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <p>&copy; 2025 Kytran Empowerment Inc. All rights reserved.</p>
            <p class="caption">"Strength through Strategy. Brotherhood through Purpose."</p>
        </div>
    </footer>

    <div id="google_translate_element" style="text-align: center; margin-top: 20px;"></div>
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script src="script.js"></script>
    <script>
        let userSessionId = localStorage.getItem('userSessionId');
        if (!userSessionId) {
            userSessionId = crypto.randomUUID();
            localStorage.setItem('userSessionId', userSessionId);
            console.log("New session ID generated:", userSessionId);
        } else {
            console.log("Using existing session ID:", userSessionId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuIcon = document.querySelector('.mobile-menu-icon');
            const mobileMenuOverlay = document.getElementById('mobileMenu');

            if (mobileMenuIcon && mobileMenuOverlay) {
                mobileMenuIcon.addEventListener('click', () => {
                    mobileMenuOverlay.classList.toggle('active-menu');
                    document.body.style.overflow = mobileMenuOverlay.classList.contains('active-menu') ? 'hidden' : '';
                });

                mobileMenuOverlay.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenuOverlay.classList.remove('active-menu');
                        document.body.style.overflow = '';
                    });
                });
            }

            updateCartCount(); 
            fetchProductDetails(); 
        });

        async function updateCartCount() {
            try {
                // Fetching cart count from store.kytranempowerment.com
                const response = await fetch(`https://store.kytranempowerment.com/api/cart/${userSessionId}`); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const cart = data.cart_items || [];
                const count = cart.reduce((total, item) => total + item.quantity, 0);

                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement) cartCountElement.innerText = count;
                const mobileCartCountElement = document.getElementById('mobile-cart-count');
                if (mobileCartCountElement) mobileCartCountElement.innerText = count;

            } catch (error) {
                console.error('Error updating cart count from backend:', error);
                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement) cartCountElement.innerText = '0';
                const mobileCartCountElement = document.getElementById('mobile-cart-count');
                if (mobileCartCountElement) mobileCartCountElement.innerText = '0';
            }
        }

        let currentProductData = null; 
        let allProductVariants = [];
        let uniqueColors = [];
        let uniqueSizes = [];
        let selectedColor = null;
        let selectedSize = null;
        // Flag to indicate if a valid variant is selected (for products with variants)
        // Or if it's a non-variant product (which is always considered "selected" from product perspective)
        let isVariantSelected = false; 

        async function fetchProductDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            const productLoading = document.getElementById('product-loading');
            const productError = document.getElementById('product-error');
            const productImageContainer = document.getElementById('product-image-container');
            const productInfoContainer = document.getElementById('product-info-container');
            const colorOptionsDiv = document.getElementById('color-options');
            const sizeOptionsDiv = document.getElementById('size-options');
            const colorSwatchesContainer = colorOptionsDiv.querySelector('.color-swatches'); 
            const sizeButtonsContainer = sizeOptionsDiv.querySelector('.size-buttons');
            const quantityInput = document.getElementById('quantity-input');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const variantDetailsDisplay = document.getElementById('variant-details-display');
            const productDescriptionElement = document.getElementById('product-description'); 

            productLoading.style.display = 'block'; 
            productError.style.display = 'none';
            productImageContainer.style.display = 'none';
            productInfoContainer.style.display = 'none';
            colorOptionsDiv.style.display = 'none'; 
            sizeOptionsDiv.style.display = 'none';
            variantDetailsDisplay.innerHTML = ''; 
            addToCartBtn.classList.add('disabled'); // Disable by default
            addToCartBtn.disabled = true; // Disable by default


            if (!productId) {
                productLoading.style.display = 'none';
                productError.style.display = 'block';
                productError.innerText = 'Error: Product ID not found in URL.';
                return;
            }

            try {
                // Fetching product details from store.kytranempowerment.com
                const response = await fetch(`https://store.kytranempowerment.com/api/products/${productId}`);
                if (!response.ok) {
                    const errorDetail = await response.text(); 
                    throw new Error(`HTTP error! Status: ${response.status}. Detail: ${errorDetail}`);
                }
                currentProductData = await response.json(); 

                if (!currentProductData || Object.keys(currentProductData).length === 0) {
                    productLoading.style.display = 'none';
                    productError.style.display = 'block';
                    productError.innerText = 'Product not found.';
                    return;
                }

                document.getElementById('product-name').innerText = currentProductData.name;
                if (currentProductData.description && currentProductData.description.trim() !== '' && currentProductData.description.trim() !== 'No description available.') {
                    productDescriptionElement.innerText = currentProductData.description;
                    productDescriptionElement.classList.remove('hidden-description');
                } else {
                    productDescriptionElement.classList.add('hidden-description');
                }

                document.getElementById('product-image').src = currentProductData.image_url || 'https://via.placeholder.com/400?text=No+Image';
                document.getElementById('product-price').innerText = `$${currentProductData.price.toFixed(2)}`; 

                if (currentProductData.printful_variant_ids) {
                    try {
                        allProductVariants = JSON.parse(currentProductData.printful_variant_ids);
                        
                        uniqueColors = [...new Set(allProductVariants.map(v => v.color).filter(Boolean))].sort();
                        uniqueSizes = [...new Set(allProductVariants.map(v => v.size).filter(Boolean))].sort((a, b) => {
                            const sizeOrder = ["XS", "S", "M", "L", "XL", "2XL", "3XL", "4XL", "5XL"];
                            return sizeOrder.indexOf(a) - sizeOrder.indexOf(b);
                        });

                        colorSwatchesContainer.innerHTML = '';
                        if (uniqueColors.length > 0) {
                            uniqueColors.forEach(color => {
                                const swatch = document.createElement('div');
                                swatch.className = 'color-swatch';
                                swatch.style.backgroundColor = mapColorNameToHex(color); 
                                swatch.title = color; 
                                swatch.dataset.color = color;
                                swatch.addEventListener('click', () => selectColor(color));
                                colorSwatchesContainer.appendChild(swatch);
                            });
                            colorOptionsDiv.style.display = 'block';
                            // Initially select the first color if colors exist, but clear size selection
                            selectedColor = uniqueColors[0];
                            document.querySelector(`.color-swatch[data-color="${selectedColor}"]`).classList.add('selected');
                            selectedSize = null; 
                            updateSizeButtons(); 
                        } else {
                            colorOptionsDiv.style.display = 'none';
                        }

                        sizeButtonsContainer.innerHTML = '';
                        if (uniqueSizes.length > 0) {
                            sizeOptionsDiv.style.display = 'block';
                        } else {
                            sizeOptionsDiv.style.display = 'none';
                        }
                        
                        if (uniqueColors.length === 0 && uniqueSizes.length > 0) {
                            selectedSize = uniqueSizes[0];
                            updateDisplayedVariantDetails(); 
                        } else {
                            updateDisplayedVariantDetails(); 
                        }


                    } catch (e) {
                        console.error("Error parsing Printful variants JSON:", e);
                        document.getElementById('variant-selection-container').style.display = 'none'; 
                        document.getElementById('product-price').innerText = `$${currentProductData.price.toFixed(2)}`; 
                        document.getElementById('selected-variant-id').value = '';
                        document.getElementById('selected-variant-name').value = currentProductData.name; 
                        document.getElementById('selected-variant-price').value = currentProductData.price;
                        document.getElementById('selected-variant-details-json').value = '';
                        variantDetailsDisplay.innerHTML = '';
                        isVariantSelected = true; 
                        addToCartBtn.classList.remove('disabled');
                        addToCartBtn.disabled = false;
                    }
                } else {
                    document.getElementById('variant-selection-container').style.display = 'none';
                    document.getElementById('product-price').innerText = `$${currentProductData.price.toFixed(2)}`;
                    document.getElementById('selected-variant-id').value = '';
                    document.getElementById('selected-variant-name').value = currentProductData.name; 
                    document.getElementById('selected-variant-price').value = currentProductData.price;
                    document.getElementById('selected-variant-details-json').value = '';
                    variantDetailsDisplay.innerHTML = ''; 
                    isVariantSelected = true; 
                    addToCartBtn.classList.remove('disabled'); 
                    addToCartBtn.disabled = false; 
                }

                addToCartBtn.onclick = () => {
                    const selectedVariantId = document.getElementById('selected-variant-id').value;
                    const selectedVariantName = document.getElementById('selected-variant-name').value;
                    const selectedVariantPrice = parseFloat(document.getElementById('selected-variant-price').value);
                    const selectedVariantDetailsJson = document.getElementById('selected-variant-details-json').value;
                    const quantity = parseInt(quantityInput.value, 10);

                    if (isNaN(quantity) || quantity < 1) {
                        alert('Please enter a valid quantity (1 or more).');
                        return;
                    }

                    if (allProductVariants.length > 0 && (!isVariantSelected || !selectedVariantId)) {
                        alert('Please select all required product options (e.g., color and size).');
                        return;
                    }
                     
                    const finalProductId = currentProductData.id;
                    const finalVariantId = selectedVariantId || null; 
                    const finalVariantName = selectedVariantName || currentProductData.name;
                    const finalVariantPrice = isNaN(selectedVariantPrice) ? currentProductData.price : selectedVariantPrice;
                    const finalVariantDetailsJson = finalVariantId ? selectedVariantDetailsJson : null;

                    addToCartBackend(
                        finalProductId,
                        finalVariantId,
                        quantity,
                        finalVariantName,
                        finalVariantPrice,
                        finalVariantDetailsJson
                    );
                };

                productLoading.style.display = 'none';
                productImageContainer.style.display = 'flex'; 
                productInfoContainer.style.display = 'flex'; 

            } catch (error) {
                console.error('Error fetching product details:', error);
                productLoading.style.display = 'none';
                productError.style.display = 'block';
                productError.innerText = `Failed to load product details. Please try again later. Error: ${error.message}`;
                productImageContainer.style.display = 'none';
                productInfoContainer.style.display = 'none';
                addToCartBtn.classList.add('disabled'); 
                addToCartBtn.disabled = true;
            }
        }

        function mapColorNameToHex(colorName) {
            const colorMap = {
                'black': '#000000', 'white': '#FFFFFF', 'navy': '#000080', 'dark navy': '#000050',
                'royal blue': '#4169E1', 'red': '#FF0000', 'maroon': '#800000', 'green camo': '#7C7F60',
                'dark grey': '#A9A9A9', 'silver': '#C0C0C0', 'heather/black': '#696969', 'heather grey/navy': '#778899',
                'heather grey/red': '#8B0000', 'heather grey': '#B0B0B0', 'oxford blue': '#4682B4', 'olive': '#808000',
                'charcoal': '#36454F', 'blue': '#0000FF', 'desert sunrise': '#EDC9AF', 'clear': '#E0E0E0',
                'athletic heather': '#C0C0C0', 'natural': '#F5F5DC', 'j. navy': '#2C3E50', 'black heather': '#36454F',
                'sport grey': '#999999', 'cranberry': '#800020', 'spruce': '#0A7570', 'khaki': '#C3B091',
                'stone': '#D3D3D3', 'truered': '#A80000', 'athleticheather': '#C0C0C0', 'darkheathergrey': '#36454F',
                'graphiteheather': '#555555', 'carbonheather': '#3C3C3C', 'carolina blue': '#82BBEF', 'forest': '#228B22',
                'oxford': '#002147', 'steel': '#4682B4', 'true royal': '#00008B', 'true navy': '#000080',
                'dark green': '#006400', 'kelly': '#4CBB17', 'light blue': '#ADD8E6', 'light steel': '#B0C4DE',
                'gold': '#FFD700', 'orange': '#FFA500', 'purple': '#800080', 'squad green': '#005D00',
                'sunshine': '#FFD700', 'yellow': '#FFFF00', 'irish green': '#009A49', 'safety green': '#66CD00',
                'safety orange': '#FF8C00', 'safety pink': '#FF1493', 'neon blue': '#0000FF', 'neon green': '#39FF14',
                'azalea': '#F75B70', 'berry': '#C91C5C', 'coral': '#FF7F50', 'daisy': '#FFFF00',
                'electric green': '#00FF00', 'fuchsia': '#FF00FF', 'heather sport royal': '#4169E1', 'heather radiant orchid': '#B065B8',
                'heather irish green': '#009A49', 'heather safety pink': '#FF1493', 'heather military green': '#6B8E23', 'heather dark grey': '#A9A9A9',
                'heather orange': '#FFA500', 'heather purple': '#800080', 'heather red': '#FF0000', 'heather sapphire': '#0F52BA',
                'heather sport dark green': '#006400', 'heather sport scarlet': '#FF2400', 'heather sport yellow': '#FFFF00',
            };
            return colorMap[colorName.toLowerCase()] || '#CCCCCC'; // Default to light gray if color not mapped
        }

        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
            });
            const selectedSwatch = document.querySelector(`.color-swatch[data-color="${color}"]`);
            if (selectedSwatch) {
                selectedSwatch.classList.add('selected');
            }
            
            selectedSize = null; 
            updateSizeButtons(); 
            updateDisplayedVariantDetails(); 
        }

        function selectSize(size) {
            selectedSize = size;
            document.querySelectorAll('.size-button').forEach(button => {
                button.classList.remove('selected');
            });
            const selectedButton = document.querySelector(`.size-button[data-size="${size}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }

            updateDisplayedVariantDetails(); 
        }

        function updateSizeButtons() {
            const sizeButtonsContainer = document.getElementById('size-options').querySelector('.size-buttons');
            if (!sizeButtonsContainer) { 
                console.error("Size buttons container not found!");
                return;
            }
            sizeButtonsContainer.innerHTML = ''; 

            const availableSizesForSelectedColor = new Set();
            allProductVariants.forEach(variant => {
                if ((selectedColor === null || variant.color === selectedColor) && (variant.availability_status === 'active' || variant.availability_status === true)) {
                    if (variant.size) { 
                        availableSizesForSelectedColor.add(variant.size);
                    }
                }
            });

            const sortedAvailableSizes = [...availableSizesForSelectedColor].sort((a, b) => {
                const sizeOrder = ["XS", "S", "M", "L", "XL", "2XL", "3XL", "4XL", "5XL"];
                const indexA = sizeOrder.indexOf(a);
                const indexB = sizeOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b); 
                if (indexA === -1) return 1; 
                if (indexB === -1) return -1; 
                return indexA - indexB;
            });


            if (sortedAvailableSizes.length > 0) {
                sortedAvailableSizes.forEach(size => {
                    const button = document.createElement('button');
                    button.className = 'size-button';
                    button.innerText = size;
                    button.dataset.size = size;

                    const variantAvailableWithSelectedColorAndSize = allProductVariants.some(v => 
                        (selectedColor === null || v.color === selectedColor) && 
                        v.size === size && 
                        (v.availability_status === 'active' || v.availability_status === true) 
                    );

                    if (!variantAvailableWithSelectedColorAndSize) {
                        button.classList.add('disabled');
                        button.disabled = true;
                    } else {
                        button.addEventListener('click', () => selectSize(size));
                    }
                    sizeButtonsContainer.appendChild(button);
                });
                document.getElementById('size-options').style.display = 'block'; 
            } else {
                document.getElementById('size-options').style.display = 'none'; 
            }

            const currentlySelectedSizeButton = sizeButtonsContainer.querySelector(`.size-button[data-size="${selectedSize}"]`);
            if (selectedSize && (!currentlySelectedSizeButton || currentlySelectedSizeButton.classList.contains('disabled'))) {
                selectedSize = null; 
            }
            
            updateDisplayedVariantDetails();
        }


        function updateDisplayedVariantDetails() {
            const productPriceElement = document.getElementById('product-price');
            const selectedVariantIdInput = document.getElementById('selected-variant-id');
            const selectedVariantNameInput = document.getElementById('selected-variant-name');
            const selectedVariantPriceInput = document.getElementById('selected-variant-price');
            const selectedVariantDetailsJsonInput = document.getElementById('selected-variant-details-json');
            const variantDetailsDisplay = document.getElementById('variant-details-display');
            const productImage = document.getElementById('product-image');
            const addToCartBtn = document.getElementById('add-to-cart-btn');

            let matchingVariant = null;
            isVariantSelected = false; 

            const hasVariants = allProductVariants.length > 0;
            const requiresColor = uniqueColors.length > 0;
            const requiresSize = uniqueSizes.length > 0;

            if (hasVariants) {
                if (requiresColor && requiresSize) {
                    if (selectedColor !== null && selectedSize !== null) {
                        matchingVariant = allProductVariants.find(v => v.color === selectedColor && v.size === selectedSize);
                    }
                } else if (requiresColor) {
                    if (selectedColor !== null) {
                        matchingVariant = allProductVariants.find(v => v.color === selectedColor);
                    }
                } else if (requiresSize) { 
                    if (selectedSize !== null) {
                        matchingVariant = allProductVariants.find(v => v.size === selectedSize);
                    }
                }
            }
            
            if (matchingVariant) {
                const displayPrice = parseFloat(matchingVariant.retail_price || matchingVariant.price || '0.00');
                productPriceElement.innerText = `$${displayPrice.toFixed(2)}`;
                selectedVariantIdInput.value = matchingVariant.id;
                selectedVariantNameInput.value = matchingVariant.name; 
                selectedVariantPriceInput.value = displayPrice;
                selectedVariantDetailsJsonInput.value = JSON.stringify(matchingVariant);

                let detailsHtml = '';
                if (matchingVariant.sku) detailsHtml += `<span>SKU: ${matchingVariant.sku}</span>`;
                if (matchingVariant.currency) detailsHtml += `<span>Currency: ${matchingVariant.currency}</span>`;
                detailsHtml += `<span>Availability: ${matchingVariant.availability_status || 'N/A'}</span>`;
                variantDetailsDisplay.innerHTML = detailsHtml;

                let variantImageUrl = currentProductData.image_url; 

                if (matchingVariant.files && matchingVariant.files.length > 0) {
                    const previewFile = matchingVariant.files.find(f => f.type === 'preview' || f.type === 'mockup');
                    if (previewFile && previewFile.preview_url) {
                        variantImageUrl = previewFile.preview_url;
                    } else if (matchingVariant.files[0].preview_url) {
                        variantImageUrl = matchingVariant.files[0].preview_url;
                    } else if (matchingVariant.files[0].url) { 
                        variantImageUrl = matchingVariant.files[0].url;
                    }
                }
                productImage.src = variantImageUrl || 'https://via.placeholder.com/400?text=No+Image'; 
                
                isVariantSelected = true; 
                addToCartBtn.classList.remove('disabled');
                addToCartBtn.disabled = false;

            } else if (!hasVariants) {
                productPriceElement.innerText = `$${currentProductData.price.toFixed(2)}`; 
                selectedVariantIdInput.value = ''; 
                selectedVariantNameInput.value = currentProductData.name; 
                selectedVariantPriceInput.value = currentProductData.price;
                selectedVariantDetailsJsonInput.value = ''; 
                variantDetailsDisplay.innerHTML = ''; 
                productImage.src = currentProductData.image_url || 'https://via.placeholder.com/400?text=No+Image'; 
                
                isVariantSelected = true; 
                addToCartBtn.classList.remove('disabled');
                addToCartBtn.disabled = false;

            } else {
                productPriceElement.innerText = `$${currentProductData.price.toFixed(2)}`; 
                selectedVariantIdInput.value = ''; 
                selectedVariantNameInput.value = ''; 
                selectedVariantPriceInput.value = ''; 
                selectedVariantDetailsJsonInput.value = ''; 
                variantDetailsDisplay.innerHTML = '<span style="color: red;">Please select all options.</span>'; 
                productImage.src = currentProductData.image_url || 'https://via.placeholder.com/400?text=No+Image'; 
                
                isVariantSelected = false; 
                addToCartBtn.classList.add('disabled');
                addToCartBtn.disabled = true;
            }
        }

        async function addToCartBackend(productId, selectedVariantId, quantity = 1, variantName = null, variantPrice = null, variantDetailsJson = null) {
            try {
                // CHANGED URL to store.kytranempowerment.com/api/cart/add
                const response = await fetch('https://store.kytranempowerment.com/api/cart/add', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: userSessionId,
                        product_id: productId,
                        quantity: quantity,
                        selected_printful_variant_id: selectedVariantId,
                        variant_name: variantName,
                        variant_price: variantPrice,
                        variant_details_json: variantDetailsJson
                    }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || `HTTP error! status: ${response.status}`);
                }

                alert(result.message);
                updateCartCount(); 
            } catch (error) {
                console.error('Error adding product to cart via backend:', error);
                alert(`Failed to add product to cart: ${error.message}`);
            }
        }
    </script>
</body>
</html>