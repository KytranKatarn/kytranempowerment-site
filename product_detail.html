<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Kytran Empowerment</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Lato:wght@300;700&family=League+Spartan:wght@700&family=Montserrat+Alternates:wght@600;700&family=Open+Sans&family=Oswald:wght@400;700&family=Playfair+Display+SC:ital,wght@1,400&family=Raleway:wght@500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        /* Product Detail Page Styling */
        .product-detail-section {
            padding: 60px 20px;
            background-color: #f5f5f5;
            min-height: calc(100vh - 100px - 100px);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top of the container */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .product-image-container {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .product-image-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            object-fit: contain;
            max-height: 450px;
        }

        .product-info-container {
            flex: 1;
            min-width: 350px;
            max-width: 600px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .product-info-container h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 0.5em;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .product-info-container p {
            font-family: 'Open Sans', sans-serif;
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
            margin-bottom: 1em;
        }

        .product-info-container p.price {
            font-family: 'Oswald', sans-serif;
            font-size: 2em;
            color: #e67e22;
            font-weight: 700;
            margin-bottom: 1.5em;
        }
        
        .product-options {
            margin-bottom: 1.5em;
        }

        .product-options label {
            display: block;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            margin-bottom: 8px;
            color: #34495e;
        }

        /* NEW: Variant UI styles */
        .variant-group {
            margin-bottom: 15px;
        }
        .variant-group label {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .color-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: border-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .color-swatch.selected {
            border-color: #3498db;
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(52,152,219,0.5);
        }
        .color-swatch:hover {
            transform: scale(1.05);
        }

        .size-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .size-button {
            padding: 8px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95em;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }
        .size-button.selected {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
            transform: translateY(-2px);
        }
        .size-button:hover:not(.disabled) {
            background-color: #e0e0e0;
        }
        .size-button.disabled {
            background-color: #eee;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* End NEW: Variant UI styles */


        .product-options input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Open Sans', sans-serif;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
            margin-bottom: 15px;
        }

        /* Styles for additional variant info display */
        #variant-details-display {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95em;
            color: #666;
            margin-top: 10px; /* Adjust margin for new UI */
            margin-bottom: 1em;
            line-height: 1.4;
            min-height: 20px; /* Prevent layout jump if no details */
        }
        #variant-details-display span {
            display: block;
            margin-bottom: 3px;
        }

        .product-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: auto;
        }

        .product-actions .btn-primary {
            flex-grow: 1;
            min-width: 120px;
            padding: 12px 25px;
            border-radius: 5px;
            background-color: #3498db;
            color: #fff;
            text-decoration: none;
            font-family: 'Oswald', sans-serif;
            font-size: 1.1em;
            font-weight: 400;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: center;
            border: none;
            cursor: pointer;
        }

        .product-actions .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .merch-loading, .merch-error {
            text-align: center;
            font-family: 'Open Sans', sans-serif;
            color: #555;
            padding: 40px;
            width: 100%;
        }
        .merch-error {
            color: #e74c3c;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .product-detail-section {
                flex-direction: column;
                align-items: center;
            }
            .product-image-container, .product-info-container {
                min-width: unset;
                width: 100%;
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <img src="logo.png" alt="Kytran Empowerment Logo" class="logo">
            <div class="header-text">
                <h1>KYTRAN EMPOWERMENT INC.</h1>
                <p class="subtitle">Strength through Strategy. Brotherhood through Purpose.</p>
            </div>

            <button class="mobile-menu-icon" aria-label="Toggle navigation">â˜°</button>

            <nav class="main-nav">
                <a href="index.html">Home</a>
                <a href="services.html">Services</a>
                <a href="membership.html">Membership</a>
                <a href="merch_store.html">Shop</a>
                <a href="books.html">Books</a>
                <a href="submit_story.html">Submit Story</a>
                <a href="https://k1.kytranempowerment.com/login">Member Login</a>
                <a href="cart.html">
                    Shopping Cart (<span id="cart-count">0</span>)
                </a>
            </nav>
        </div>

        <div class="mobile-menu-overlay" id="mobileMenu">
            <a href="index.html">Home</a>
            <a href="services.html">Services</a>
            <a href="membership.html">Membership</a>
            <a href="merch_store.html">Shop</a>
            <a href="books.html">Books</a>
            <a href="submit_story.html">Submit Story</a>
            <a href="https://k1.kytranempowerment.com/login">Member Login</a>
            <a href="cart.html">Shopping Cart (<span id="mobile-cart-count">0</span>)</a>
        </div>
    </header>

    <section class="product-detail-section">
        <p class="merch-loading" id="product-loading">Loading product details...</p>
        <p class="merch-error" id="product-error" style="display: none;"></p>

        <div class="product-image-container" id="product-image-container" style="display: none;">
            <img id="product-image" src="" alt="Product Image">
        </div>

        <div class="product-info-container" id="product-info-container" style="display: none;">
            <h2 id="product-name"></h2>
            <p id="product-description"></p>
            <p class="price" id="product-price"></p>
            
            <div id="variant-selection-container">
                <div class="variant-group" id="color-options" style="display: none;">
                    <label>Color:</label>
                    <div class="color-swatches">
                        </div>
                </div>

                <div class="variant-group" id="size-options" style="display: none;">
                    <label>Size:</label>
                    <div class="size-buttons">
                        </div>
                </div>
                
                <input type="hidden" id="selected-variant-id">
                <input type="hidden" id="selected-variant-name">
                <input type="hidden" id="selected-variant-price">
                <input type="hidden" id="selected-variant-details-json">

                <div id="variant-details-display"></div>
            </div>

            <div class="product-options">
                <label for="quantity-input">Quantity:</label>
                <input type="number" id="quantity-input" value="1" min="1">
            </div>

            <div class="product-actions">
                <a href="merch_store.html" class="btn-primary">Back to Store</a>
                <button id="add-to-cart-btn" class="btn-primary">Add to Cart</button>
                <a href="cart.html" class="btn-primary">View Cart</a>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <p>&copy; 2025 Kytran Empowerment Inc. All rights reserved.</p>
            <p class="caption">"Strength through Strategy. Brotherhood through Purpose."</p>
        </div>
    </footer>

    <div id="google_translate_element" style="text-align: center; margin-top: 20px;"></div>
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script src="script.js"></script>
    <script>
        let userSessionId = localStorage.getItem('userSessionId');
        if (!userSessionId) {
            userSessionId = crypto.randomUUID();
            localStorage.setItem('userSessionId', userSessionId);
            console.log("New session ID generated:", userSessionId);
        } else {
            console.log("Using existing session ID:", userSessionId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuIcon = document.querySelector('.mobile-menu-icon');
            const mobileMenuOverlay = document.getElementById('mobileMenu');

            if (mobileMenuIcon && mobileMenuOverlay) {
                mobileMenuIcon.addEventListener('click', () => {
                    mobileMenuOverlay.classList.toggle('active-menu');
                    document.body.style.overflow = mobileMenuOverlay.classList.contains('active-menu') ? 'hidden' : '';
                });
                mobileMenuOverlay.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenuOverlay.classList.remove('active-menu');
                        document.body.style.overflow = '';
                    });
                });
            }

            updateCartCount(); 
            fetchProductDetails(); 
        });

        async function updateCartCount() {
            try {
                const response = await fetch(`https://k1.kytranempowerment.com/api/cart/${userSessionId}`); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const cart = data.cart_items || [];
                const count = cart.reduce((total, item) => total + item.quantity, 0);

                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement) cartCountElement.innerText = count;
                const mobileCartCountElement = document.getElementById('mobile-cart-count');
                if (mobileCartCountElement) mobileCartCountElement.innerText = count;

            } catch (error) {
                console.error('Error updating cart count from backend:', error);
                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement) cartCountElement.innerText = '0';
                const mobileCartCountElement = document.getElementById('mobile-cart-count');
                if (mobileCartCountElement) mobileCartCountElement.innerText = '0';
            }
        }

        let currentProductData = null; 
        let allProductVariants = [];
        let uniqueColors = [];
        let uniqueSizes = [];
        let selectedColor = null;
        let selectedSize = null;

        async function fetchProductDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            const productLoading = document.getElementById('product-loading');
            const productError = document.getElementById('product-error');
            const productImageContainer = document.getElementById('product-image-container');
            const productInfoContainer = document.getElementById('product-info-container');
            const colorOptionsDiv = document.getElementById('color-options');
            const sizeOptionsDiv = document.getElementById('size-options');
            const colorSwatchesContainer = colorOptionsDiv.querySelector('.color-swatches');
            const sizeButtonsContainer = sizeOptionsDiv.querySelector('.size-buttons');
            const quantityInput = document.getElementById('quantity-input');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const variantDetailsDisplay = document.getElementById('variant-details-display');

            productLoading.style.display = 'block'; 
            productError.style.display = 'none';
            productImageContainer.style.display = 'none';
            productInfoContainer.style.display = 'none';
            colorOptionsDiv.style.display = 'none'; // Hide variant sections by default
            sizeOptionsDiv.style.display = 'none';
            variantDetailsDisplay.innerHTML = ''; // Clear previous details

            if (!productId) {
                productLoading.style.display = 'none';
                productError.style.display = 'block';
                productError.innerText = 'Error: Product ID not found in URL.';
                return;
            }

            try {
                const response = await fetch(`https://store.kytranempowerment.com/api/products/${productId}`);
                if (!response.ok) {
                    const errorDetail = await response.text(); 
                    throw new Error(`HTTP error! Status: ${response.status}. Detail: ${errorDetail}`);
                }
                currentProductData = await response.json(); 

                if (!currentProductData || Object.keys(currentProductData).length === 0) {
                    productLoading.style.display = 'none';
                    productError.style.display = 'block';
                    productError.innerText = 'Product not found.';
                    return;
                }

                document.getElementById('product-name').innerText = currentProductData.name;
                document.getElementById('product-description').innerText = currentProductData.description || 'No description available.';
                document.getElementById('product-image').src = currentProductData.image_url || 'https://via.placeholder.com/400?text=No+Image';
                document.getElementById('product-price').innerText = `$${currentProductData.price.toFixed(2)}`; // Set initial price from base product

                if (currentProductData.printful_variant_ids) {
                    try {
                        allProductVariants = JSON.parse(currentProductData.printful_variant_ids);
                        
                        // Extract unique colors and sizes
                        uniqueColors = [...new Set(allProductVariants.map(v => v.color).filter(Boolean))].sort();
                        uniqueSizes = [...new Set(allProductVariants.map(v => v.size).filter(Boolean))].sort((a, b) => {
                            // Basic size sorting (XS, S, M, L, XL, etc.)
                            const sizeOrder = ["XS", "S", "M", "L", "XL", "2XL", "3XL", "4XL", "5XL"];
                            return sizeOrder.indexOf(a) - sizeOrder.indexOf(b);
                        });

                        // Render Color Swatches
                        colorSwatchesContainer.innerHTML = '';
                        if (uniqueColors.length > 0) {
                            uniqueColors.forEach(color => {
                                const swatch = document.createElement('div');
                                swatch.className = 'color-swatch';
                                swatch.style.backgroundColor = mapColorNameToHex(color); // Function to map names to hex
                                swatch.title = color; // Tooltip
                                swatch.dataset.color = color;
                                swatch.addEventListener('click', () => selectColor(color));
                                colorSwatchesContainer.appendChild(swatch);
                            });
                            colorOptionsDiv.style.display = 'block';
                        } else {
                            colorOptionsDiv.style.display = 'none';
                        }

                        // Render Size Buttons
                        sizeButtonsContainer.innerHTML = '';
                        if (uniqueSizes.length > 0) {
                            uniqueSizes.forEach(size => {
                                const button = document.createElement('button');
                                button.className = 'size-button';
                                button.innerText = size;
                                button.dataset.size = size;
                                button.addEventListener('click', () => selectSize(size));
                                sizeButtonsContainer.appendChild(button);
                            });
                            sizeOptionsDiv.style.display = 'block';
                        } else {
                            sizeOptionsDiv.style.display = 'none';
                        }

                        // Initial selection (select first color and first size if available)
                        if (uniqueColors.length > 0) {
                            selectColor(uniqueColors[0]);
                        }
                        if (selectedColor && uniqueSizes.length > 0) {
                            selectSize(uniqueSizes[0]);
                        } else if (uniqueSizes.length > 0 && !selectedColor) { // If no colors, but sizes exist
                            selectSize(uniqueSizes[0]);
                        }

                        // If no specific color or size variants, just display base product price
                        if (uniqueColors.length === 0 && uniqueSizes.length === 0) {
                            document.getElementById('product-price').innerText = `$${currentProductData.price.toFixed(2)}`;
                        }

                    } catch (e) {
                        console.error("Error parsing Printful variants JSON:", e);
                        // Fallback to base product price if JSON parsing fails
                        document.getElementById('variant-selection-container').style.display = 'none'; // Hide all variant selectors
                        document.getElementById('product-price').innerText = `$${currentProductData.price.toFixed(2)}`;
                    }
                } else {
                    // No printful_variant_ids field, hide variant selectors
                    document.getElementById('variant-selection-container').style.display = 'none';
                    document.getElementById('product-price').innerText = `$${currentProductData.price.toFixed(2)}`;
                }

                addToCartBtn.onclick = () => {
                    const selectedVariantId = document.getElementById('selected-variant-id').value;
                    const selectedVariantName = document.getElementById('selected-variant-name').value;
                    const selectedVariantPrice = parseFloat(document.getElementById('selected-variant-price').value);
                    const selectedVariantDetailsJson = document.getElementById('selected-variant-details-json').value;
                    const quantity = parseInt(quantityInput.value, 10);

                    if (isNaN(quantity) || quantity < 1) {
                        alert('Please enter a valid quantity (1 or more).');
                        return;
                    }

                    // If product has variants, ensure one is selected
                    if (allProductVariants.length > 0 && (!selectedVariantId || selectedVariantId === '')) {
                        alert('Please select a color and size.');
                        return;
                    }
                     // If product has no variants, but add to cart is clicked, use base product data
                    const finalProductId = currentProductData.id;
                    const finalVariantId = allProductVariants.length === 0 ? '' : selectedVariantId;
                    const finalVariantName = allProductVariants.length === 0 ? currentProductData.name : selectedVariantName;
                    const finalVariantPrice = allProductVariants.length === 0 ? currentProductData.price : selectedVariantPrice;
                    const finalVariantDetailsJson = allProductVariants.length === 0 ? '' : selectedVariantDetailsJson;

                    addToCartBackend(
                        finalProductId,
                        finalVariantId,
                        quantity,
                        finalVariantName,
                        finalVariantPrice,
                        finalVariantDetailsJson
                    );
                };

                // Hide loading, show content
                productLoading.style.display = 'none';
                productImageContainer.style.display = 'flex'; 
                productInfoContainer.style.display = 'flex'; 

            } catch (error) {
                console.error('Error fetching product details:', error);
                productLoading.style.display = 'none';
                productError.style.display = 'block';
                productError.innerText = `Failed to load product details. Please try again later. Error: ${error.message}`;
                productImageContainer.style.display = 'none';
                productInfoContainer.style.display = 'none';
            }
        }

        // Helper to map common color names to hex codes for swatches
        function mapColorNameToHex(colorName) {
            const colorMap = {
                'black': '#000000',
                'white': '#FFFFFF',
                'navy': '#000080',
                'dark navy': '#000050',
                'royal blue': '#4169E1',
                'red': '#FF0000',
                'maroon': '#800000',
                'green camo': '#7C7F60', /* A common green camo tone */
                'dark grey': '#A9A9A9',
                'silver': '#C0C0C0',
                'heather/black': '#696969', /* A medium gray for heather */
                'heather grey/navy': '#778899', /* Slate Gray */
                'heather grey/red': '#8B0000', /* Dark Red for combo */
                'heather grey': '#B0B0B0', /* Light Grey */
                'oxford blue': '#4682B4', /* Steel Blue */
                'olive': '#808000',
                'charcoal': '#36454F',
                'blue': '#0000FF',
                'desert sunrise': '#EDC9AF', /* Light brown/peach */
                'clear': '#E0E0E0', /* Light gray for clear */
                'athletic heather': '#C0C0C0', /* Light gray for athletic heather */
                'natural': '#F5F5DC', /* Beige */
                'j. navy': '#2C3E50', /* Dark blue similar to Navy */
                'black heather': '#36454F', /* Dark gray for black heather */
                'sport grey': '#999999', /* Mid-grey for sport grey */
                'cranberry': '#800020', /* Deep red for cranberry */
                'spruce': '#0A7570', /* Dark green-blue for spruce */
                'khaki': '#C3B091', /* Light brownish-yellow */
                'stone': '#D3D3D3', /* Light gray */
                // Add more mappings as needed based on Printful's color names
            };
            return colorMap[colorName.toLowerCase()] || '#CCCCCC'; // Default to light gray if color not mapped
        }

        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
            });
            document.querySelector(`.color-swatch[data-color="${color}"]`).classList.add('selected');
            
            // Re-render sizes based on selected color and update current variant details
            updateSizeButtons();
            updateDisplayedVariantDetails();
        }

        function selectSize(size) {
            selectedSize = size;
            document.querySelectorAll('.size-button').forEach(button => {
                button.classList.remove('selected');
            });
            document.querySelector(`.size-button[data-size="${size}"]`).classList.add('selected');

            updateDisplayedVariantDetails();
        }

        function updateSizeButtons() {
            const sizeButtonsContainer = document.getElementById('size-buttons');
            sizeButtonsContainer.innerHTML = ''; // Clear existing size buttons

            const availableSizesForColor = new Set();
            allProductVariants.forEach(variant => {
                if (variant.color === selectedColor || !selectedColor) { // If a color is selected, filter by it, else show all sizes
                    availableSizesForColor.add(variant.size);
                }
            });

            uniqueSizes.forEach(size => {
                const button = document.createElement('button');
                button.className = 'size-button';
                button.innerText = size;
                button.dataset.size = size;

                const variantExists = allProductVariants.some(v => 
                    (v.color === selectedColor || !selectedColor) && v.size === size
                );
                const isAvailable = allProductVariants.some(v => 
                    (v.color === selectedColor || !selectedColor) && 
                    v.size === size && 
                    (v.availability_status === 'active' || v.availability_status === true) // Check Printful availability
                );

                if (!variantExists || !isAvailable) {
                    button.classList.add('disabled');
                    button.disabled = true;
                } else {
                    button.addEventListener('click', () => selectSize(size));
                }
                sizeButtonsContainer.appendChild(button);
            });

            // If the previously selected size is no longer available for the new color, deselect it
            const currentSelectedSizeButton = document.querySelector(`.size-button.selected`);
            if (currentSelectedSizeButton && !availableSizesForColor.has(currentSelectedSizeButton.dataset.size)) {
                currentSelectedSizeButton.classList.remove('selected');
                selectedSize = null; // Clear selected size
            }
            
            // If no size is selected or current selected size is disabled, try to select the first available size
            if (!selectedSize || document.querySelector(`.size-button[data-size="${selectedSize}"]`).classList.contains('disabled')) {
                const firstAvailableSizeButton = sizeButtonsContainer.querySelector('.size-button:not(.disabled)');
                if (firstAvailableSizeButton) {
                    selectSize(firstAvailableSizeButton.dataset.size);
                } else {
                    selectedSize = null; // No sizes available for this color
                    updateDisplayedVariantDetails(); // Update display to show no selected variant price
                }
            }
        }


        function updateDisplayedVariantDetails() {
            const productPriceElement = document.getElementById('product-price');
            const selectedVariantIdInput = document.getElementById('selected-variant-id');
            const selectedVariantNameInput = document.getElementById('selected-variant-name');
            const selectedVariantPriceInput = document.getElementById('selected-variant-price');
            const selectedVariantDetailsJsonInput = document.getElementById('selected-variant-details-json');
            const variantDetailsDisplay = document.getElementById('variant-details-display');
            const productImage = document.getElementById('product-image');

            let matchingVariant = null;

            if (allProductVariants.length > 0) {
                // Find a variant that matches both selected color and size
                matchingVariant = allProductVariants.find(v => {
                    const colorMatch = selectedColor ? v.color === selectedColor : true; // Match if color selected, or if no color is selected (for products with only sizes)
                    const sizeMatch = selectedSize ? v.size === selectedSize : true; // Match if size selected, or if no size is selected (for products with only colors)
                    return colorMatch && sizeMatch;
                });

                // Fallback for products that only have colors or only sizes, but not both.
                // If a product has only colors and no sizes (or vice versa), and one is selected.
                if (!matchingVariant && (selectedColor || selectedSize)) {
                    if (selectedColor && !selectedSize && uniqueSizes.length === 0) { // Product has colors, but no sizes
                        matchingVariant = allProductVariants.find(v => v.color === selectedColor);
                    } else if (selectedSize && !selectedColor && uniqueColors.length === 0) { // Product has sizes, but no colors
                        matchingVariant = allProductVariants.find(v => v.size === selectedSize);
                    }
                }
            }
            
            if (matchingVariant) {
                const displayPrice = parseFloat(matchingVariant.retail_price || matchingVariant.price || '0.00');
                productPriceElement.innerText = `$${displayPrice.toFixed(2)}`;
                selectedVariantIdInput.value = matchingVariant.id;
                selectedVariantNameInput.value = matchingVariant.name; // Use Printful variant name
                selectedVariantPriceInput.value = displayPrice;
                selectedVariantDetailsJsonInput.value = JSON.stringify(matchingVariant);

                // Update additional variant details display
                let detailsHtml = '';
                if (matchingVariant.sku) detailsHtml += `<span>SKU: ${matchingVariant.sku}</span>`;
                if (matchingVariant.currency) detailsHtml += `<span>Currency: ${matchingVariant.currency}</span>`;
                // No need to repeat size/color here as they are visually selected
                detailsHtml += `<span>Availability: ${matchingVariant.availability_status || 'N/A'}</span>`;
                variantDetailsDisplay.innerHTML = detailsHtml;

                // --- Image Switching Logic ---
                let variantImageUrl = currentProductData.image_url; // Default to base product image

                if (matchingVariant.files && matchingVariant.files.length > 0) {
                    // Prioritize specific 'preview' or 'mockup' files for the variant
                    const previewFile = matchingVariant.files.find(f => f.type === 'preview' || f.type === 'mockup');
                    if (previewFile && previewFile.preview_url) {
                        variantImageUrl = previewFile.preview_url;
                    } else if (matchingVariant.files[0].preview_url) {
                        variantImageUrl = matchingVariant.files[0].preview_url;
                    } else if (matchingVariant.files[0].url) { 
                        variantImageUrl = matchingVariant.files[0].url;
                    }
                }
                productImage.src = variantImageUrl || 'https://via.placeholder.com/400?text=No+Image'; // Update main image

            } else if (currentProductData) {
                // Fallback to base product data if no variant is perfectly matched
                productPriceElement.innerText = `$${currentProductData.price.toFixed(2)}`; 
                selectedVariantIdInput.value = ''; 
                selectedVariantNameInput.value = currentProductData.name; 
                selectedVariantPriceInput.value = currentProductData.price;
                selectedVariantDetailsJsonInput.value = '';
                variantDetailsDisplay.innerHTML = ''; // Clear variant specific details
                productImage.src = currentProductData.image_url || 'https://via.placeholder.com/400?text=No+Image'; // Reset to base image
            } else {
                // Should not happen if product details loaded, but as a final fallback
                productPriceElement.innerText = '$0.00'; 
                selectedVariantIdInput.value = '';
                selectedVariantNameInput.value = 'N/A';
                selectedVariantPriceInput.value = 0.00;
                selectedVariantDetailsJsonInput.value = '';
                variantDetailsDisplay.innerHTML = ''; 
                productImage.src = 'https://via.placeholder.com/400?text=No+Image'; 
            }
        }

        async function addToCartBackend(productId, selectedVariantId, quantity = 1, variantName = null, variantPrice = null, variantDetailsJson = null) {
            try {
                const response = await fetch('https://k1.kytranempowerment.com/api/cart', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: userSessionId,
                        product_id: productId,
                        quantity: quantity,
                        selected_printful_variant_id: selectedVariantId,
                        variant_name: variantName,
                        variant_price: variantPrice,
                        variant_details_json: variantDetailsJson
                    }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || `HTTP error! status: ${response.status}`);
                }

                alert(result.message);
                updateCartCount(); 
            } catch (error) {
                console.error('Error adding product to cart via backend:', error);
                alert(`Failed to add product to cart: ${error.message}`);
            }
        }
    </script>
</body>
</html>